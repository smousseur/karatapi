image: maven:3.9.9-jdk-17

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  TESTCONTAINERS_RYUK_DISABLED: "true"
  TESTCONTAINERS_CHECKS_DISABLE: "true"
  TESTCONTAINERS_REUSE_ENABLE: "true"
  TESTCONTAINERS_VERBOSE_LOGGING: "true"
  TESTCONTAINERS_LOG_LEVEL: "DEBUG"
  TESTCONTAINERS_HOST_OVERRIDE: "host.docker.internal"
  GITHUB_REPO: "smousseur/karatapi"
  GITHUB_HOST: "github.com"

cache:
  paths:
    - .m2/repository

stages:
  - ✈ github

push_github:
  stage: ✈ github
  image: debian:bullseye-slim
  before_script:
    - apt-get update && apt-get install -y git  
  script:
    - echo "Clone github repository"
    - git clone --mirror "https://${GITHUB_HOST}/${GITHUB_REPO}.git" github_mirror
    - echo "Setting github as remote repository"
    - cd github_mirror
    - git remote add gitlab "${CI_REPOSITORY_URL}"
    - git fetch gitlab --tags
    - echo "Pushing to github"
    - git log
    - git remote -v
    - git push --mirror "https://${GITHUB_TOKEN}@${GITHUB_HOST}/${GITHUB_REPO}.git" -f
  when: manual
